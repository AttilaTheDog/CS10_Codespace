#!/bin/bash

IMAGE="rocker/tidyverse"
NAME="rstudio"

# Formatting
bold=$(tput bold)
normal=$(tput sgr0)

# Helper
function spin() {
    local pid=$1
    local spinner='|/-\'
    while [ -d /proc/$pid ]; do
        for i in $(seq 0 3); do
            printf "\rHit CTRL-C to stop the server [%c] " "${spinner:$i:1}"
            sleep 0.5
        done
    done
    printf "\n"
}

# Check for $1
if [[ $# -eq 1 ]]; then
    if [[ "$1" == "restart" ]]; then
        docker stop  "$NAME" > /dev/null 2>&1
        docker rm "$NAME" > /dev/null 2>&1
    elif [[ "$1" == "stop" ]]; then
        docker stop "$NAME" > /dev/null 2>&1
        docker rm "$NAME" > /dev/null 2>&1
        exit $?
    fi
fi

# Check for running image
id=$(docker ps --all --filter "name=rstudio" --quiet)
if [[ -n "$id" ]]; then

    # Stop current container (so as to restart port forwarding)
    docker stop "$id" > /dev/null

    # Try to remove in case created but somehow not started
    docker rm "$id" &> /dev/null
fi

# Pull latest image
docker pull "$IMAGE"

# Create container
# https://rocker-project.org/images/versioned/rstudio.html#environment-variables
docker create \
    --env DISABLE_AUTH=true \
    --name "$NAME" \
    --publish 8787:8787 \
    --rm \
    --volume "$LOCAL_WORKSPACE_FOLDER":"/workspaces/$RepositoryName" \
    rocker/tidyverse > /dev/null

# Customize rstudio-prefs.json
jq ".initial_working_directory = \"/workspaces/$RepositoryName\"" /opt/cs50/lib/rstudio/rstudio-prefs.json > /tmp/rstudio-prefs.json

# Copy files into container
docker cp --quiet /opt/cs50/lib/rstudio/_icons.css rstudio:/tmp
docker cp --quiet /opt/cs50/lib/rstudio/rstudio-server.json rstudio:/etc/rstudio/
docker cp --quiet /tmp/rstudio-prefs.json rstudio:/etc/rstudio/

# Start container
docker start rstudio > /dev/null

# Inject CSS
docker exec rstudio sh -c "cat /tmp/_icons.css >> /usr/lib/rstudio-server/www/css/icons.css"

# Attach to container
docker attach rstudio &> /dev/null &
pid=$!

# Spin until container stops
spin $pid
wait $pid
