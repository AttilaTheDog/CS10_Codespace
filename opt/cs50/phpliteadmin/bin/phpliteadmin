#!/usr/bin/env python3

import argparse
import os
import re
import subprocess
import shutil
import termcolor
import tempfile


DEFAULT_HOST = '127.0.0.1'
DEFAULT_PORT = 8082
PHP_FILE = '/opt/cs50/phpliteadmin/share/index.php'
PHP_THEME = '/opt/cs50/phpliteadmin/share/phpliteadmin.css'
EXECUTABLE = '/usr/bin/php'


def main():
    args = parse_args()

    if not os.path.isfile(args.path):
        sys.exit("Database not found, exiting...")

    # Preparing files
    temp_dir = tempfile.mkdtemp()
    shutil.copy(PHP_FILE, temp_dir)
    shutil.copy(PHP_THEME, temp_dir)

    # Update database path and name in phpliteadmin
    with open(f'{temp_dir}/{os.path.basename(PHP_FILE)}', 'r+') as file:
        content = file.read()
        content = re.sub('ENV_DATABASE_PATH', os.path.abspath(args.path), content)
        content = re.sub('ENV_DATABASE_NAME', os.path.basename(args.path), content)
        file.seek(0)
        file.write(content)
        file.truncate()

    # Construct php command
    command = [EXECUTABLE, '-S', f'{DEFAULT_HOST}:{DEFAULT_PORT}', '-t', temp_dir]
    subprocess.run(['fuser', '-k', f'{DEFAULT_PORT}/tcp'], stdout=subprocess.DEVNULL, stderr=subprocess.STDOUT)

    display_codespace_url(DEFAULT_PORT)


def parse_args():
    parser = argparse.ArgumentParser()
    parser.add_argument('path')
    return parser.parse_args()


def display_codespace_url(port):
    codespace_name = os.getenv('CODESPACE_NAME')
    port_forwarding_domain = os.getenv('GITHUB_CODESPACES_PORT_FORWARDING_DOMAIN', 'app.github.dev')
    if codespace_name is not None:
        local_address = f'https://{codespace_name}-{port}.{port_forwarding_domain}/'
        msg = f"\nphpLiteAdmin running on {local_address}\n"
        print(termcolor.colored(msg, 'green'))


if __name__ == '__main__':
    main()
